#define LIBDECOMP_ENABLE_BUILTIN_BACKEND_CAPSTONE
#include <libdecomp/libdecomp.h>
#include <libdecomp/formatter/lang_c.h>

#define BASE_ADDRESS 0x1000

static void *query(void *ctx, size_t index)
{
    cs_insn *i = ctx;
    return &i[index];
}

int main()
{
    static const uint8_t data[] = {
        0xff, 0x83, 0x00, 0xd1, 0xe0, 0x0f, 0x00, 0xb9, 
        0xe0, 0x0f, 0x40, 0xb9, 0xe0, 0x1f, 0x00, 0xb9, 
        0xe0, 0x0f, 0x40, 0xb9, 0xe0, 0x03, 0x00, 0x4b, 
        0xe0, 0x1b, 0x00, 0xb9, 0x0e, 0x00, 0x00, 0x14, 
        0xe0, 0x1f, 0x40, 0xb9, 0x1f, 0x00, 0x00, 0x71, 
        0xaa, 0x00, 0x00, 0x54, 0xe0, 0x1f, 0x40, 0xb9, 
        0x00, 0x24, 0x00, 0x11, 0xe0, 0x1f, 0x00, 0xb9, 
        0x04, 0x00, 0x00, 0x14, 0xe0, 0x1f, 0x40, 0xb9, 
        0x00, 0x1c, 0x00, 0x11, 0xe0, 0x1f, 0x00, 0xb9, 
        0xe0, 0x1b, 0x40, 0xb9, 0x00, 0x04, 0x00, 0x11, 
        0xe0, 0x1b, 0x00, 0xb9, 0xe1, 0x1b, 0x40, 0xb9, 
        0xe0, 0x0f, 0x40, 0xb9, 0x3f, 0x00, 0x00, 0x6b, 
        0x0d, 0xfe, 0xff, 0x54, 0xe0, 0x1f, 0x40, 0xb9, 
        0xff, 0x83, 0x00, 0x91, 0xc0, 0x03, 0x5f, 0xd6, 
    };

    csh handle;
    cs_insn *insn;
    size_t count;
    cs_arch arch = CS_ARCH_ARM64;
    cs_mode mode = CS_MODE_ARM;

    if (cs_open(arch, mode, &handle) != CS_ERR_OK) {
        printf("failed to open capstone\n");
        return 1;
    }

    cs_option(handle, CS_OPT_DETAIL, CS_OPT_ON); 
    count = cs_disasm(handle, data, sizeof(data), BASE_ADDRESS, 0, &insn);

    DCProgram *program = DC_ProgramCreate();
    DC_ProgramSetImage(program, query, insn, count);

    DCDisassemblerBackend backend = DC_DisassemblerCapstone(arch, mode);
    DC_ProgramSetBackend(program, &backend);
    
    DCFormatterContext formatter = DC_FormatterLangC();
    DC_ProgramSetFormatter(program, &formatter);

    char buffer[1024];
    DC_ProgramDecompile(program, 
                        BASE_ADDRESS, 
                        data, sizeof(data),
                        buffer, sizeof(buffer));

    printf("%s", buffer);
    return 0;
}
